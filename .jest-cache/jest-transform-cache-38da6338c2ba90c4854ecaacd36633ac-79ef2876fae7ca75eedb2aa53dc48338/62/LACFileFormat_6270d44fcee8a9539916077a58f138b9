33d82675dc451e373cd797c65a2895c6
"use strict";
/**
 * .lac 文件格式读写处理器
 * 基于原版 C# ExportedCapture 的精确实现
 * 与原软件 100% 兼容
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.LACFileFormat = void 0;
const tslib_1 = require("tslib");
const fs = tslib_1.__importStar(require("fs"));
const path = tslib_1.__importStar(require("path"));
/**
 * .lac 文件格式处理器 - 简化版，与C#原版兼容
 */
class LACFileFormat {
    /**
     * 保存.lac文件 - 对应C# MainWindow中的保存逻辑
     */
    static async save(filePath, captureSession, selectedRegions, includeRawSamples = false) {
        try {
            // 构建ExportedCapture对象，与C#版本完全对应
            const exportedCapture = {
                Settings: captureSession
            };
            // 添加原始样本数据（如果需要）- 对应C# ExportedCapture.Samples
            if (includeRawSamples && captureSession.captureChannels.length > 0) {
                exportedCapture.Samples = this.packChannelSamplesToUInt128Array(captureSession.captureChannels);
            }
            // 添加选择区域（如果有）
            if (selectedRegions && selectedRegions.length > 0) {
                exportedCapture.SelectedRegions = selectedRegions.map(region => ({
                    FirstSample: region.firstSample,
                    LastSample: region.lastSample,
                    RegionName: region.regionName,
                    R: region.color.r,
                    G: region.color.g,
                    B: region.color.b,
                    A: region.color.a
                }));
            }
            // 序列化为JSON - 使用与C#版本相同的方式
            const jsonContent = JSON.stringify(exportedCapture, this.sampleRegionReplacer, 2);
            // 确保目录存在
            const dir = path.dirname(filePath);
            if (!fs.existsSync(dir)) {
                await fs.promises.mkdir(dir, { recursive: true });
            }
            // 写入文件
            await fs.promises.writeFile(filePath, jsonContent, 'utf-8');
            const fileSize = Buffer.byteLength(jsonContent, 'utf-8');
            return {
                success: true,
                filePath,
                data: exportedCapture,
                fileSize
            };
        }
        catch (error) {
            return {
                success: false,
                error: `Failed to save file: ${error instanceof Error ? error.message : 'Unknown error'}`
            };
        }
    }
    /**
     * 加载.lac文件 - 对应C# MainWindow中的加载逻辑
     */
    static async load(filePath) {
        try {
            // 检查文件是否存在
            if (!fs.existsSync(filePath)) {
                return {
                    success: false,
                    error: `File not found: ${filePath}`
                };
            }
            // 读取文件内容
            const fileContent = await fs.promises.readFile(filePath, 'utf-8');
            const fileSize = Buffer.byteLength(fileContent, 'utf-8');
            // 解析JSON - 使用与C#版本相同的方式
            let exportedCapture;
            try {
                exportedCapture = JSON.parse(fileContent);
                // 手动处理SampleRegion如果需要
                if (exportedCapture.SelectedRegions) {
                    exportedCapture.SelectedRegions = this.sampleRegionReviver('SelectedRegions', exportedCapture.SelectedRegions);
                }
            }
            catch (parseError) {
                return {
                    success: false,
                    error: `Invalid JSON format: ${parseError instanceof Error ? parseError.message : 'Unknown parse error'}`
                };
            }
            // 基本验证
            if (!exportedCapture.Settings) {
                return {
                    success: false,
                    error: 'Invalid .lac file: missing Settings'
                };
            }
            return {
                success: true,
                filePath,
                data: exportedCapture,
                fileSize
            };
        }
        catch (error) {
            return {
                success: false,
                error: `Failed to load file: ${error instanceof Error ? error.message : 'Unknown error'}`
            };
        }
    }
    /**
     * JSON序列化时的自定义处理器 - 对应C# SampleRegionConverter.WriteJson
     */
    static sampleRegionReplacer(key, value) {
        // 处理SampleRegion的颜色序列化 - 对应C#的颜色处理
        if (key === 'SelectedRegions' && Array.isArray(value)) {
            return value.map((region) => {
                if (region && typeof region === 'object') {
                    // 确保颜色字段以正确的格式序列化
                    return {
                        FirstSample: region.FirstSample,
                        LastSample: region.LastSample,
                        RegionName: region.RegionName,
                        R: region.R,
                        G: region.G,
                        B: region.B,
                        A: region.A
                    };
                }
                return region;
            });
        }
        return value;
    }
    /**
     * JSON反序列化时的自定义处理器 - 对应C# SampleRegionConverter.ReadJson
     */
    static sampleRegionReviver(key, value) {
        // 处理SampleRegion的颜色反序列化
        if (key === 'SelectedRegions' && Array.isArray(value)) {
            return value.map((region) => {
                if (region && typeof region === 'object' &&
                    'R' in region && 'G' in region && 'B' in region && 'A' in region) {
                    // 恢复颜色对象结构
                    return {
                        FirstSample: region.FirstSample,
                        LastSample: region.LastSample,
                        RegionName: region.RegionName,
                        R: region.R,
                        G: region.G,
                        B: region.B,
                        A: region.A
                    };
                }
                return region;
            });
        }
        return value;
    }
    /**
     * 转换ExportedCapture为CaptureSession - 包含样本数据提取
     */
    static convertToCaptureSession(exportedCapture) {
        if (!exportedCapture) {
            throw new Error('ExportedCapture cannot be null or undefined');
        }
        const captureSession = exportedCapture.Settings;
        // 如果有原始样本数据，提取到各个通道 - 对应C# ExtractSamples方法
        if (exportedCapture.Samples && exportedCapture.Samples.length > 0) {
            this.extractSamplesFromUInt128Array(captureSession.captureChannels, exportedCapture.Samples);
        }
        return captureSession;
    }
    /**
     * 从CaptureSession创建ExportedCapture
     */
    static createFromCaptureSession(captureSession, selectedRegions, includeRawSamples = false) {
        if (!captureSession) {
            throw new Error('CaptureSession cannot be null or undefined');
        }
        const exportedCapture = {
            Settings: captureSession
        };
        // 添加原始样本数据（如果需要）
        if (includeRawSamples && captureSession.captureChannels.length > 0) {
            exportedCapture.Samples = this.packChannelSamplesToUInt128Array(captureSession.captureChannels);
        }
        if (selectedRegions && selectedRegions.length > 0) {
            exportedCapture.SelectedRegions = selectedRegions.map(region => ({
                FirstSample: region.firstSample,
                LastSample: region.lastSample,
                RegionName: region.regionName,
                R: region.color.r,
                G: region.color.g,
                B: region.color.b,
                A: region.color.a
            }));
        }
        return exportedCapture;
    }
    /**
     * 将通道样本数据打包为UInt128数组 - 对应C#的相反操作
     */
    static packChannelSamplesToUInt128Array(channels) {
        if (channels.length === 0 || !channels[0].samples) {
            return [];
        }
        const sampleCount = channels[0].samples.length;
        const uint128Array = [];
        for (let sampleIndex = 0; sampleIndex < sampleCount; sampleIndex++) {
            // 创建128位值 - 使用BigInt处理大整数
            let uint128Value = BigInt(0);
            for (let channelIndex = 0; channelIndex < Math.min(channels.length, 128); channelIndex++) {
                const channel = channels[channelIndex];
                if (channel.samples && channel.samples[sampleIndex]) {
                    // 设置对应的位 - (1 << channelIndex)
                    uint128Value |= BigInt(1) << BigInt(channelIndex);
                }
            }
            // 转换为十六进制字符串存储
            uint128Array.push(uint128Value.toString(16).padStart(32, '0'));
        }
        return uint128Array;
    }
    /**
     * 从UInt128数组提取通道样本数据 - 对应C# ExtractSamples方法
     */
    static extractSamplesFromUInt128Array(channels, uint128Array) {
        for (let channelIndex = 0; channelIndex < channels.length; channelIndex++) {
            const channel = channels[channelIndex];
            if (!channel)
                continue;
            // 创建位掩码 - 对应C# UInt128 mask = (UInt128)1 << ChannelIndex
            const mask = BigInt(1) << BigInt(channelIndex);
            // 提取样本数据
            const samples = new Uint8Array(uint128Array.length);
            for (let sampleIndex = 0; sampleIndex < uint128Array.length; sampleIndex++) {
                try {
                    // 从十六进制字符串还原BigInt
                    const uint128Value = BigInt(`0x${uint128Array[sampleIndex]}`);
                    // 检查对应位是否为1 - 对应C# (s & mask) != 0 ? (byte)1 : (byte)0
                    samples[sampleIndex] = (uint128Value & mask) !== BigInt(0) ? 1 : 0;
                }
                catch (error) {
                    // 处理无效的十六进制字符串，设置为0
                    samples[sampleIndex] = 0;
                }
            }
            channel.samples = samples;
        }
    }
}
exports.LACFileFormat = LACFileFormat;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvc2hhcmUvc2FtYmEvdnNjb2RlLWV4dGVuc2lvbi9waWNvLWxvZ2ljYW5hbHl6ZXIvc3JjL21vZGVscy9MQUNGaWxlRm9ybWF0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOzs7O0FBRUgsK0NBQXlCO0FBQ3pCLG1EQUE2QjtBQTRDN0I7O0dBRUc7QUFDSCxNQUFhLGFBQWE7SUFDeEI7O09BRUc7SUFDSSxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FDdEIsUUFBZ0IsRUFDaEIsY0FBOEIsRUFDOUIsZUFLRSxFQUNGLG9CQUE2QixLQUFLO1FBRWxDLElBQUk7WUFDRixnQ0FBZ0M7WUFDaEMsTUFBTSxlQUFlLEdBQW9CO2dCQUN2QyxRQUFRLEVBQUUsY0FBYzthQUN6QixDQUFDO1lBRUYsK0NBQStDO1lBQy9DLElBQUksaUJBQWlCLElBQUksY0FBYyxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUNsRSxlQUFlLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxnQ0FBZ0MsQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLENBQUM7YUFDakc7WUFFRCxjQUFjO1lBQ2QsSUFBSSxlQUFlLElBQUksZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ2pELGVBQWUsQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQy9ELFdBQVcsRUFBRSxNQUFNLENBQUMsV0FBVztvQkFDL0IsVUFBVSxFQUFFLE1BQU0sQ0FBQyxVQUFVO29CQUM3QixVQUFVLEVBQUUsTUFBTSxDQUFDLFVBQVU7b0JBQzdCLENBQUMsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQ2pCLENBQUMsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQ2pCLENBQUMsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQ2pCLENBQUMsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7aUJB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LENBQUMsQ0FBQztZQUUvQyxTQUFTO1lBQ1QsTUFBTSxPQUFPLEdBQUcsSUFBSSxVQUFVLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXBELEtBQUssSUFBSSxXQUFXLEdBQUcsQ0FBQyxFQUFFLFdBQVcsR0FBRyxZQUFZLENBQUMsTUFBTSxFQUFFLFdBQVcsRUFBRSxFQUFFO2dCQUMxRSxJQUFJO29CQUNGLG1CQUFtQjtvQkFDbkIsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLEtBQUssWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztvQkFFOUQsdURBQXVEO29CQUN2RCxPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDcEU7Z0JBQUMsT0FBTyxLQUFLLEVBQUU7b0JBQ2Qsb0JBQW9CO29CQUNwQixPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUMxQjthQUNGO1lBRUQsT0FBTyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7U0FDM0I7SUFDSCxDQUFDO0NBQ0Y7QUFyU0Qsc0NBcVNDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3NoYXJlL3NhbWJhL3ZzY29kZS1leHRlbnNpb24vcGljby1sb2dpY2FuYWx5emVyL3NyYy9tb2RlbHMvTEFDRmlsZUZvcm1hdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogLmxhYyDmlofku7bmoLzlvI/or7vlhpnlpITnkIblmahcclxuICog5Z+65LqO5Y6f54mIIEMjIEV4cG9ydGVkQ2FwdHVyZSDnmoTnsr7noa7lrp7njrBcclxuICog5LiO5Y6f6L2v5Lu2IDEwMCUg5YW85a65XHJcbiAqL1xyXG5cclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQge1xyXG4gIFRyaWdnZXJUeXBlLFxyXG4gIERldmljZUluZm9cclxufSBmcm9tICcuL0FuYWx5emVyVHlwZXMnO1xyXG5pbXBvcnQge1xyXG4gIENhcHR1cmVTZXNzaW9uLFxyXG4gIEFuYWx5emVyQ2hhbm5lbCxcclxuICBCdXJzdEluZm9cclxufSBmcm9tICcuL0NhcHR1cmVNb2RlbHMnO1xyXG5cclxuLyoqXHJcbiAqIOagt+acrOWMuuWfn+S/oeaBryAtIOWvueW6lEMjIFNhbXBsZVJlZ2lvblxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBTYW1wbGVSZWdpb24ge1xyXG4gIEZpcnN0U2FtcGxlOiBudW1iZXI7XHJcbiAgTGFzdFNhbXBsZTogbnVtYmVyO1xyXG4gIFJlZ2lvbk5hbWU6IHN0cmluZztcclxuICBSOiBudW1iZXI7XHJcbiAgRzogbnVtYmVyO1xyXG4gIEI6IG51bWJlcjtcclxuICBBOiBudW1iZXI7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDlr7zlh7rnmoTph4fpm4bmlbDmja4gLSDnsr7noa7lr7nlupRDIyBFeHBvcnRlZENhcHR1cmVcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgRXhwb3J0ZWRDYXB0dXJlIHtcclxuICBTZXR0aW5nczogQ2FwdHVyZVNlc3Npb247IC8vIOWvueW6lEMjIEV4cG9ydGVkQ2FwdHVyZS5TZXR0aW5nc1xyXG4gIFNhbXBsZXM/OiBzdHJpbmdbXTsgLy8g5a+55bqUQyMgRXhwb3J0ZWRDYXB0dXJlLlNhbXBsZXMgKFVJbnQxMjhbXSkgLSDlrZjlgqjkuLrljYHlha3ov5vliLblrZfnrKbkuLJcclxuICBTZWxlY3RlZFJlZ2lvbnM/OiBTYW1wbGVSZWdpb25bXTsgLy8g5a+55bqUQyMgRXhwb3J0ZWRDYXB0dXJlLlNlbGVjdGVkUmVnaW9uc1xyXG59XHJcblxyXG4vKipcclxuICogLmxhYyDmlofku7bmk43kvZznu5PmnpxcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgTEFDRmlsZVJlc3VsdCB7XHJcbiAgc3VjY2VzczogYm9vbGVhbjtcclxuICBmaWxlUGF0aD86IHN0cmluZztcclxuICBkYXRhPzogRXhwb3J0ZWRDYXB0dXJlO1xyXG4gIGVycm9yPzogc3RyaW5nO1xyXG4gIGZpbGVTaXplPzogbnVtYmVyO1xyXG59XHJcblxyXG4vKipcclxuICogLmxhYyDmlofku7bmoLzlvI/lpITnkIblmaggLSDnroDljJbniYjvvIzkuI5DI+WOn+eJiOWFvOWuuVxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIExBQ0ZpbGVGb3JtYXQge1xyXG4gIC8qKlxyXG4gICAqIOS/neWtmC5sYWPmlofku7YgLSDlr7nlupRDIyBNYWluV2luZG935Lit55qE5L+d5a2Y6YC76L6RXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyBhc3luYyBzYXZlKFxyXG4gICAgZmlsZVBhdGg6IHN0cmluZyxcclxuICAgIGNhcHR1cmVTZXNzaW9uOiBDYXB0dXJlU2Vzc2lvbixcclxuICAgIHNlbGVjdGVkUmVnaW9ucz86IEFycmF5PHtcclxuICAgICAgZmlyc3RTYW1wbGU6IG51bWJlcjtcclxuICAgICAgbGFzdFNhbXBsZTogbnVtYmVyO1xyXG4gICAgICByZWdpb25OYW1lOiBzdHJpbmc7XHJcbiAgICAgIGNvbG9yOiB7IHI6IG51bWJlcjsgZzogbnVtYmVyOyBiOiBudW1iZXI7IGE6IG51bWJlciB9O1xyXG4gICAgfT4sXHJcbiAgICBpbmNsdWRlUmF3U2FtcGxlczogYm9vbGVhbiA9IGZhbHNlXHJcbiAgKTogUHJvbWlzZTxMQUNGaWxlUmVzdWx0PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyDmnoTlu7pFeHBvcnRlZENhcHR1cmXlr7nosaHvvIzkuI5DI+eJiOacrOWujOWFqOWvueW6lFxyXG4gICAgICBjb25zdCBleHBvcnRlZENhcHR1cmU6IEV4cG9ydGVkQ2FwdHVyZSA9IHtcclxuICAgICAgICBTZXR0aW5nczogY2FwdHVyZVNlc3Npb25cclxuICAgICAgfTtcclxuXHJcbiAgICAgIC8vIOa3u+WKoOWOn+Wni+agt+acrOaVsOaNru+8iOWmguaenOmcgOimge+8iS0g5a+55bqUQyMgRXhwb3J0ZWRDYXB0dXJlLlNhbXBsZXNcclxuICAgICAgaWYgKGluY2x1ZGVSYXdTYW1wbGVzICYmIGNhcHR1cmVTZXNzaW9uLmNhcHR1cmVDaGFubmVscy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgZXhwb3J0ZWRDYXB0dXJlLlNhbXBsZXMgPSB0aGlzLnBhY2tDaGFubmVsU2FtcGxlc1RvVUludDEyOEFycmF5KGNhcHR1cmVTZXNzaW9uLmNhcHR1cmVDaGFubmVscyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIOa3u+WKoOmAieaLqeWMuuWfn++8iOWmguaenOacie+8iVxyXG4gICAgICBpZiAoc2VsZWN0ZWRSZWdpb25zICYmIHNlbGVjdGVkUmVnaW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgZXhwb3J0ZWRDYXB0dXJlLlNlbGVjdGVkUmVnaW9ucyA9IHNlbGVjdGVkUmVnaW9ucy5tYXAocmVnaW9uID0+ICh7XHJcbiAgICAgICAgICBGaXJzdFNhbXBsZTogcmVnaW9uLmZpcnN0U2FtcGxlLFxyXG4gICAgICAgICAgTGFzdFNhbXBsZTogcmVnaW9uLmxhc3RTYW1wbGUsXHJcbiAgICAgICAgICBSZWdpb25OYW1lOiByZWdpb24ucmVnaW9uTmFtZSxcclxuICAgICAgICAgIFI6IHJlZ2lvbi5jb2xvci5yLFxyXG4gICAgICAgICAgRzogcmVnaW9uLmNvbG9yLmcsXHJcbiAgICAgICAgICBCOiByZWdpb24uY29sb3IuYixcclxuICAgICAgICAgIEE6IHJlZ2lvbi5jb2xvci5hXHJcbiAgICAgICAgfSkpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyDluo/liJfljJbkuLpKU09OIC0g5L2/55So5LiOQyPniYjmnKznm7jlkIznmoTmlrnlvI9cclxuICAgICAgY29uc3QganNvbkNvbnRlbnQgPSBKU09OLnN0cmluZ2lmeShleHBvcnRlZENhcHR1cmUsIHRoaXMuc2FtcGxlUmVnaW9uUmVwbGFjZXIsIDIpO1xyXG5cclxuICAgICAgLy8g56Gu5L+d55uu5b2V5a2Y5ZyoXHJcbiAgICAgIGNvbnN0IGRpciA9IHBhdGguZGlybmFtZShmaWxlUGF0aCk7XHJcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhkaXIpKSB7XHJcbiAgICAgICAgYXdhaXQgZnMucHJvbWlzZXMubWtkaXIoZGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8g5YaZ5YWl5paH5Lu2XHJcbiAgICAgIGF3YWl0IGZzLnByb21pc2VzLndyaXRlRmlsZShmaWxlUGF0aCwganNvbkNvbnRlbnQsICd1dGYtOCcpO1xyXG4gICAgICBjb25zdCBmaWxlU2l6ZSA9IEJ1ZmZlci5ieXRlTGVuZ3RoKGpzb25Db250ZW50LCAndXRmLTgnKTtcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICBmaWxlUGF0aCxcclxuICAgICAgICBkYXRhOiBleHBvcnRlZENhcHR1cmUsXHJcbiAgICAgICAgZmlsZVNpemVcclxuICAgICAgfTtcclxuXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgIGVycm9yOiBgRmFpbGVkIHRvIHNhdmUgZmlsZTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliqDovb0ubGFj5paH5Lu2IC0g5a+55bqUQyMgTWFpbldpbmRvd+S4reeahOWKoOi9vemAu+i+kVxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0aWMgYXN5bmMgbG9hZChmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxMQUNGaWxlUmVzdWx0PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyDmo4Dmn6Xmlofku7bmmK/lkKblrZjlnKhcclxuICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGZpbGVQYXRoKSkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgIGVycm9yOiBgRmlsZSBub3QgZm91bmQ6ICR7ZmlsZVBhdGh9YFxyXG4gICAgICAgIH07XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIOivu+WPluaWh+S7tuWGheWuuVxyXG4gICAgICBjb25zdCBmaWxlQ29udGVudCA9IGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKGZpbGVQYXRoLCAndXRmLTgnKTtcclxuICAgICAgY29uc3QgZmlsZVNpemUgPSBCdWZmZXIuYnl0ZUxlbmd0aChmaWxlQ29udGVudCwgJ3V0Zi04Jyk7XHJcblxyXG4gICAgICAvLyDop6PmnpBKU09OIC0g5L2/55So5LiOQyPniYjmnKznm7jlkIznmoTmlrnlvI9cclxuICAgICAgbGV0IGV4cG9ydGVkQ2FwdHVyZTogRXhwb3J0ZWRDYXB0dXJlO1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGV4cG9ydGVkQ2FwdHVyZSA9IEpTT04ucGFyc2UoZmlsZUNvbnRlbnQpO1xyXG5cclxuICAgICAgICAvLyDmiYvliqjlpITnkIZTYW1wbGVSZWdpb27lpoLmnpzpnIDopoFcclxuICAgICAgICBpZiAoZXhwb3J0ZWRDYXB0dXJlLlNlbGVjdGVkUmVnaW9ucykge1xyXG4gICAgICAgICAgZXhwb3J0ZWRDYXB0dXJlLlNlbGVjdGVkUmVnaW9ucyA9IHRoaXMuc2FtcGxlUmVnaW9uUmV2aXZlcignU2VsZWN0ZWRSZWdpb25zJywgZXhwb3J0ZWRDYXB0dXJlLlNlbGVjdGVkUmVnaW9ucykgYXMgU2FtcGxlUmVnaW9uW107XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoIChwYXJzZUVycm9yKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgZXJyb3I6IGBJbnZhbGlkIEpTT04gZm9ybWF0OiAke3BhcnNlRXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IHBhcnNlRXJyb3IubWVzc2FnZSA6ICdVbmtub3duIHBhcnNlIGVycm9yJ31gXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8g5Z+65pys6aqM6K+BXHJcbiAgICAgIGlmICghZXhwb3J0ZWRDYXB0dXJlLlNldHRpbmdzKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgZXJyb3I6ICdJbnZhbGlkIC5sYWMgZmlsZTogbWlzc2luZyBTZXR0aW5ncydcclxuICAgICAgICB9O1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgZmlsZVBhdGgsXHJcbiAgICAgICAgZGF0YTogZXhwb3J0ZWRDYXB0dXJlLFxyXG4gICAgICAgIGZpbGVTaXplXHJcbiAgICAgIH07XHJcblxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogYEZhaWxlZCB0byBsb2FkIGZpbGU6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSlNPTuW6j+WIl+WMluaXtueahOiHquWumuS5ieWkhOeQhuWZqCAtIOWvueW6lEMjIFNhbXBsZVJlZ2lvbkNvbnZlcnRlci5Xcml0ZUpzb25cclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBzYW1wbGVSZWdpb25SZXBsYWNlcihrZXk6IHN0cmluZywgdmFsdWU6IGFueSk6IGFueSB7XHJcbiAgICAvLyDlpITnkIZTYW1wbGVSZWdpb27nmoTpopzoibLluo/liJfljJYgLSDlr7nlupRDI+eahOminOiJsuWkhOeQhlxyXG4gICAgaWYgKGtleSA9PT0gJ1NlbGVjdGVkUmVnaW9ucycgJiYgQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcclxuICAgICAgcmV0dXJuIHZhbHVlLm1hcCgocmVnaW9uOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAocmVnaW9uICYmIHR5cGVvZiByZWdpb24gPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAvLyDnoa7kv53popzoibLlrZfmrrXku6XmraPnoa7nmoTmoLzlvI/luo/liJfljJZcclxuICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIEZpcnN0U2FtcGxlOiByZWdpb24uRmlyc3RTYW1wbGUsXHJcbiAgICAgICAgICAgIExhc3RTYW1wbGU6IHJlZ2lvbi5MYXN0U2FtcGxlLFxyXG4gICAgICAgICAgICBSZWdpb25OYW1lOiByZWdpb24uUmVnaW9uTmFtZSxcclxuICAgICAgICAgICAgUjogcmVnaW9uLlIsXHJcbiAgICAgICAgICAgIEc6IHJlZ2lvbi5HLFxyXG4gICAgICAgICAgICBCOiByZWdpb24uQixcclxuICAgICAgICAgICAgQTogcmVnaW9uLkFcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZWdpb247XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHZhbHVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSlNPTuWPjeW6j+WIl+WMluaXtueahOiHquWumuS5ieWkhOeQhuWZqCAtIOWvueW6lEMjIFNhbXBsZVJlZ2lvbkNvbnZlcnRlci5SZWFkSnNvblxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIHNhbXBsZVJlZ2lvblJldml2ZXIoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpOiBhbnkge1xyXG4gICAgLy8g5aSE55CGU2FtcGxlUmVnaW9u55qE6aKc6Imy5Y+N5bqP5YiX5YyWXHJcbiAgICBpZiAoa2V5ID09PSAnU2VsZWN0ZWRSZWdpb25zJyAmJiBBcnJheS5pc0FycmF5KHZhbHVlKSkge1xyXG4gICAgICByZXR1cm4gdmFsdWUubWFwKChyZWdpb246IGFueSkgPT4ge1xyXG4gICAgICAgIGlmIChyZWdpb24gJiYgdHlwZW9mIHJlZ2lvbiA9PT0gJ29iamVjdCcgJiZcclxuICAgICAgICAgICAgJ1InIGluIHJlZ2lvbiAmJiAnRycgaW4gcmVnaW9uICYmICdCJyBpbiByZWdpb24gJiYgJ0EnIGluIHJlZ2lvbikge1xyXG4gICAgICAgICAgLy8g5oGi5aSN6aKc6Imy5a+56LGh57uT5p6EXHJcbiAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBGaXJzdFNhbXBsZTogcmVnaW9uLkZpcnN0U2FtcGxlLFxyXG4gICAgICAgICAgICBMYXN0U2FtcGxlOiByZWdpb24uTGFzdFNhbXBsZSxcclxuICAgICAgICAgICAgUmVnaW9uTmFtZTogcmVnaW9uLlJlZ2lvbk5hbWUsXHJcbiAgICAgICAgICAgIFI6IHJlZ2lvbi5SLFxyXG4gICAgICAgICAgICBHOiByZWdpb24uRyxcclxuICAgICAgICAgICAgQjogcmVnaW9uLkIsXHJcbiAgICAgICAgICAgIEE6IHJlZ2lvbi5BXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVnaW9uO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiB2YWx1ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOi9rOaNokV4cG9ydGVkQ2FwdHVyZeS4ukNhcHR1cmVTZXNzaW9uIC0g5YyF5ZCr5qC35pys5pWw5o2u5o+Q5Y+WXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyBjb252ZXJ0VG9DYXB0dXJlU2Vzc2lvbihleHBvcnRlZENhcHR1cmU6IEV4cG9ydGVkQ2FwdHVyZSk6IENhcHR1cmVTZXNzaW9uIHtcclxuICAgIGlmICghZXhwb3J0ZWRDYXB0dXJlKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignRXhwb3J0ZWRDYXB0dXJlIGNhbm5vdCBiZSBudWxsIG9yIHVuZGVmaW5lZCcpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNhcHR1cmVTZXNzaW9uID0gZXhwb3J0ZWRDYXB0dXJlLlNldHRpbmdzO1xyXG5cclxuICAgIC8vIOWmguaenOacieWOn+Wni+agt+acrOaVsOaNru+8jOaPkOWPluWIsOWQhOS4qumAmumBkyAtIOWvueW6lEMjIEV4dHJhY3RTYW1wbGVz5pa55rOVXHJcbiAgICBpZiAoZXhwb3J0ZWRDYXB0dXJlLlNhbXBsZXMgJiYgZXhwb3J0ZWRDYXB0dXJlLlNhbXBsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICB0aGlzLmV4dHJhY3RTYW1wbGVzRnJvbVVJbnQxMjhBcnJheShjYXB0dXJlU2Vzc2lvbi5jYXB0dXJlQ2hhbm5lbHMsIGV4cG9ydGVkQ2FwdHVyZS5TYW1wbGVzKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gY2FwdHVyZVNlc3Npb247XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDku45DYXB0dXJlU2Vzc2lvbuWIm+W7ukV4cG9ydGVkQ2FwdHVyZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0aWMgY3JlYXRlRnJvbUNhcHR1cmVTZXNzaW9uKFxyXG4gICAgY2FwdHVyZVNlc3Npb246IENhcHR1cmVTZXNzaW9uLFxyXG4gICAgc2VsZWN0ZWRSZWdpb25zPzogQXJyYXk8e1xyXG4gICAgICBmaXJzdFNhbXBsZTogbnVtYmVyO1xyXG4gICAgICBsYXN0U2FtcGxlOiBudW1iZXI7XHJcbiAgICAgIHJlZ2lvbk5hbWU6IHN0cmluZztcclxuICAgICAgY29sb3I6IHsgcjogbnVtYmVyOyBnOiBudW1iZXI7IGI6IG51bWJlcjsgYTogbnVtYmVyIH07XHJcbiAgICB9PixcclxuICAgIGluY2x1ZGVSYXdTYW1wbGVzOiBib29sZWFuID0gZmFsc2VcclxuICApOiBFeHBvcnRlZENhcHR1cmUge1xyXG4gICAgaWYgKCFjYXB0dXJlU2Vzc2lvbikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhcHR1cmVTZXNzaW9uIGNhbm5vdCBiZSBudWxsIG9yIHVuZGVmaW5lZCcpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGV4cG9ydGVkQ2FwdHVyZTogRXhwb3J0ZWRDYXB0dXJlID0ge1xyXG4gICAgICBTZXR0aW5nczogY2FwdHVyZVNlc3Npb25cclxuICAgIH07XHJcblxyXG4gICAgLy8g5re75Yqg5Y6f5aeL5qC35pys5pWw5o2u77yI5aaC5p6c6ZyA6KaB77yJXHJcbiAgICBpZiAoaW5jbHVkZVJhd1NhbXBsZXMgJiYgY2FwdHVyZVNlc3Npb24uY2FwdHVyZUNoYW5uZWxzLmxlbmd0aCA+IDApIHtcclxuICAgICAgZXhwb3J0ZWRDYXB0dXJlLlNhbXBsZXMgPSB0aGlzLnBhY2tDaGFubmVsU2FtcGxlc1RvVUludDEyOEFycmF5KGNhcHR1cmVTZXNzaW9uLmNhcHR1cmVDaGFubmVscyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHNlbGVjdGVkUmVnaW9ucyAmJiBzZWxlY3RlZFJlZ2lvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICBleHBvcnRlZENhcHR1cmUuU2VsZWN0ZWRSZWdpb25zID0gc2VsZWN0ZWRSZWdpb25zLm1hcChyZWdpb24gPT4gKHtcclxuICAgICAgICBGaXJzdFNhbXBsZTogcmVnaW9uLmZpcnN0U2FtcGxlLFxyXG4gICAgICAgIExhc3RTYW1wbGU6IHJlZ2lvbi5sYXN0U2FtcGxlLFxyXG4gICAgICAgIFJlZ2lvbk5hbWU6IHJlZ2lvbi5yZWdpb25OYW1lLFxyXG4gICAgICAgIFI6IHJlZ2lvbi5jb2xvci5yLFxyXG4gICAgICAgIEc6IHJlZ2lvbi5jb2xvci5nLFxyXG4gICAgICAgIEI6IHJlZ2lvbi5jb2xvci5iLFxyXG4gICAgICAgIEE6IHJlZ2lvbi5jb2xvci5hXHJcbiAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZXhwb3J0ZWRDYXB0dXJlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bCG6YCa6YGT5qC35pys5pWw5o2u5omT5YyF5Li6VUludDEyOOaVsOe7hCAtIOWvueW6lEMj55qE55u45Y+N5pON5L2cXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgcGFja0NoYW5uZWxTYW1wbGVzVG9VSW50MTI4QXJyYXkoY2hhbm5lbHM6IEFuYWx5emVyQ2hhbm5lbFtdKTogc3RyaW5nW10ge1xyXG4gICAgaWYgKGNoYW5uZWxzLmxlbmd0aCA9PT0gMCB8fCAhY2hhbm5lbHNbMF0uc2FtcGxlcykge1xyXG4gICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc2FtcGxlQ291bnQgPSBjaGFubmVsc1swXS5zYW1wbGVzLmxlbmd0aDtcclxuICAgIGNvbnN0IHVpbnQxMjhBcnJheTogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICBmb3IgKGxldCBzYW1wbGVJbmRleCA9IDA7IHNhbXBsZUluZGV4IDwgc2FtcGxlQ291bnQ7IHNhbXBsZUluZGV4KyspIHtcclxuICAgICAgLy8g5Yib5bu6MTI45L2N5YC8IC0g5L2/55SoQmlnSW505aSE55CG5aSn5pW05pWwXHJcbiAgICAgIGxldCB1aW50MTI4VmFsdWUgPSBCaWdJbnQoMCk7XHJcblxyXG4gICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCBNYXRoLm1pbihjaGFubmVscy5sZW5ndGgsIDEyOCk7IGNoYW5uZWxJbmRleCsrKSB7XHJcbiAgICAgICAgY29uc3QgY2hhbm5lbCA9IGNoYW5uZWxzW2NoYW5uZWxJbmRleF07XHJcbiAgICAgICAgaWYgKGNoYW5uZWwuc2FtcGxlcyAmJiBjaGFubmVsLnNhbXBsZXNbc2FtcGxlSW5kZXhdKSB7XHJcbiAgICAgICAgICAvLyDorr7nva7lr7nlupTnmoTkvY0gLSAoMSA8PCBjaGFubmVsSW5kZXgpXHJcbiAgICAgICAgICB1aW50MTI4VmFsdWUgfD0gQmlnSW50KDEpIDw8IEJpZ0ludChjaGFubmVsSW5kZXgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy8g6L2s5o2i5Li65Y2B5YWt6L+b5Yi25a2X56ym5Liy5a2Y5YKoXHJcbiAgICAgIHVpbnQxMjhBcnJheS5wdXNoKHVpbnQxMjhWYWx1ZS50b1N0cmluZygxNikucGFkU3RhcnQoMzIsICcwJykpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB1aW50MTI4QXJyYXk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDku45VSW50MTI45pWw57uE5o+Q5Y+W6YCa6YGT5qC35pys5pWw5o2uIC0g5a+55bqUQyMgRXh0cmFjdFNhbXBsZXPmlrnms5VcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBleHRyYWN0U2FtcGxlc0Zyb21VSW50MTI4QXJyYXkoY2hhbm5lbHM6IEFuYWx5emVyQ2hhbm5lbFtdLCB1aW50MTI4QXJyYXk6IHN0cmluZ1tdKTogdm9pZCB7XHJcbiAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCBjaGFubmVscy5sZW5ndGg7IGNoYW5uZWxJbmRleCsrKSB7XHJcbiAgICAgIGNvbnN0IGNoYW5uZWwgPSBjaGFubmVsc1tjaGFubmVsSW5kZXhdO1xyXG4gICAgICBpZiAoIWNoYW5uZWwpIGNvbnRpbnVlO1xyXG5cclxuICAgICAgLy8g5Yib5bu65L2N5o6p56CBIC0g5a+55bqUQyMgVUludDEyOCBtYXNrID0gKFVJbnQxMjgpMSA8PCBDaGFubmVsSW5kZXhcclxuICAgICAgY29uc3QgbWFzayA9IEJpZ0ludCgxKSA8PCBCaWdJbnQoY2hhbm5lbEluZGV4KTtcclxuXHJcbiAgICAgIC8vIOaPkOWPluagt+acrOaVsOaNrlxyXG4gICAgICBjb25zdCBzYW1wbGVzID0gbmV3IFVpbnQ4QXJyYXkodWludDEyOEFycmF5Lmxlbmd0aCk7XHJcblxyXG4gICAgICBmb3IgKGxldCBzYW1wbGVJbmRleCA9IDA7IHNhbXBsZUluZGV4IDwgdWludDEyOEFycmF5Lmxlbmd0aDsgc2FtcGxlSW5kZXgrKykge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAvLyDku47ljYHlha3ov5vliLblrZfnrKbkuLLov5jljp9CaWdJbnRcclxuICAgICAgICAgIGNvbnN0IHVpbnQxMjhWYWx1ZSA9IEJpZ0ludChgMHgke3VpbnQxMjhBcnJheVtzYW1wbGVJbmRleF19YCk7XHJcblxyXG4gICAgICAgICAgLy8g5qOA5p+l5a+55bqU5L2N5piv5ZCm5Li6MSAtIOWvueW6lEMjIChzICYgbWFzaykgIT0gMCA/IChieXRlKTEgOiAoYnl0ZSkwXHJcbiAgICAgICAgICBzYW1wbGVzW3NhbXBsZUluZGV4XSA9ICh1aW50MTI4VmFsdWUgJiBtYXNrKSAhPT0gQmlnSW50KDApID8gMSA6IDA7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgIC8vIOWkhOeQhuaXoOaViOeahOWNgeWFrei/m+WItuWtl+espuS4su+8jOiuvue9ruS4ujBcclxuICAgICAgICAgIHNhbXBsZXNbc2FtcGxlSW5kZXhdID0gMDtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNoYW5uZWwuc2FtcGxlcyA9IHNhbXBsZXM7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==